@using DotA.WebEdit.Models;
@using DotA.Model.Extensions;
@using DotA.WebEdit.Helpers;
@{
    Layout = null;
}

@model DynSingleView<Ability>

    @using (Html.BeginForm("AbilityUpdate", "Hero"))
    {
        Html.AntiForgeryToken();

        <table border="1">
            @{
                var prefix = $"{nameof(Model.Item)}.";
                foreach (var dv in Model.DisplayValues)
                {
                    string modelPrefix = $"{nameof(Model.Item)}.";
                    string propName = $"{nameof(Model.Item)}.{dv.PropertyName}";

                    <tr><td>@dv.PropertyDisplayName</td><td>

                    @if (dv.PrimaryKey)
                    {
                        @Html.Hidden(propName);
                    }
                    @if (!dv.Editable || dv.PrimaryKey)
                    {

                        switch (dv.Type)
                        {
                            case DisplayValueType.String:
                                @Html.Display(propName);
                                break;
                            case DisplayValueType.Decimal:
                                @Html.DisplayFor(Model.GetExpression<decimal>(dv));
                                break;
                            case DisplayValueType.PickList_Multi:
                                @Html.ListBox($"{prefix}{dv.PropertyName}", dv.PicklistOptionsAsListItems(Model.Item))
                                break;
                            case DisplayValueType.PickList:
                                @Html.DropDownList($"{prefix}{dv.PropertyName}")
                                break;
                            case DisplayValueType.DecimalList:
                                @Html.DisplayFor(Model.GetExpression<List<decimal>>(dv)); //TODO: adjust editor to disply with levels
                                break;
                            default:
                                @Html.DisplayFor(Model.GetExpression<object>(dv));
                                break;
                        }
                    }
                    else
                    {
                        switch (dv.Type)
                        {
                            //break;
                            case DisplayValueType.DecimalList:
                                @Html.Partial("ListEdit",
                                              dv.SrcProperty.GetValue<List<decimal>>(Model.Item),
                                              new ViewDataDictionary { { "Name", dv.PropertyName },
                                                                       { "ModelPrefix", modelPrefix },
                                                                       { "IncludeLabels", true },
                                                                       { "LabelPrefix", "Lvl" },
                                                                       { "ItemCount", 4 }
                                              })
                                break;
                            default:
                                @Html.Editor(propName, new { Name = dv.PropertyName, ModelPrefix = modelPrefix });
                                break;
                        }
                    }
                    </td></tr>
                }
             }
            <tr></tr>
        </table>        
        <input type="submit" name="Update" />
        <h4>Effects</h4>
            foreach(Effect effect in Model.Item.Effects)
            {
                @Html.Partial("Effect", new DynSingleView<Effect>(effect))
            }
      }

@using (Html.BeginForm("NewEffectView", "Hero", new { parentName = Model.Item.Name }))
{
    <input type="submit" name="newEffect" value="New Effect"/>
}
<p />